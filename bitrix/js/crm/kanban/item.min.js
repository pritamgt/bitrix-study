(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Item=function(t){BX.Kanban.Item.apply(this,arguments);this.container=null;this.timer=null;this.popupTooltip=null;this.plannerCurrent=null};BX.CRM.Kanban.Item.prototype={__proto__:BX.Kanban.Item.prototype,constructor:BX.CRM.Kanban.Item,lastPosition:{columnId:null,targetId:null},clipTitle:function(t){var e=t;var i=e.split(" ");var n="<span>"+i[i.length-1]+"</span>";i.splice(i.length-1);e=i.join(" ")+" "+n;return e},setDataKey:function(t,e){var i=this.getData();i[t]=e;this.setData(i)},getDataKey:function(t){var e=this.getData();return e[t]},switchClass:function(t,e,i){if(i){BX.addClass(t,e)}else{BX.removeClass(t,e)}},switchVisible:function(t,e){if(e){t.style.display=""}else{BX.hide(t)}},getLastPosition:function(){return this.lastPosition},setLastPosition:function(){var t=this.getColumn();var e=t.getNextItemSibling(this);this.lastPosition={columnId:t.getId(),targetId:e?e.getId():0}},render:function(){if(!this.container){this.createLayout()}var t=this.getData();var e=this.getColumn();var i=e.getColor();var n=BX.util.hex2rgb(i);var a="rgba("+n.r+","+n.g+","+n.b+","+".7)";BX.style(this.container,"border-left","3px solid "+a);this.link.innerHTML=this.clipTitle(t.name);this.link.setAttribute("href",t.link);if(this.totalPrice){this.totalPrice.innerHTML=t.price_formatted}this.date.textContent=t.date;if(t.contactId&&t.contactName){this.contactName.textContent=BX.util.htmlspecialcharsback(t.contactName);this.contactName.setAttribute("href",t.contactLink);this.switchVisible(this.contactName,true)}else{this.switchVisible(this.contactName,false)}if(this.planner){this.switchPlanner()}var s=["Phone","Email","Im"];for(var o=0,r=s.length;o<r;o++){var c=s[o];var l="crm-kanban-item-contact-"+c.toLowerCase()+"-disabled";BX.unbindAll(this["contact"+c]);if(t[c.toLowerCase()]){BX.bind(this["contact"+c],"click",BX.delegate(this.clickContact,this));this.switchClass(this["contact"+c],l,false)}else{BX.bind(this["contact"+c],"mouseover",BX.delegate(function(){var t=BX.data(BX.proxy_context,"type");this.showTooltip(BX.message("CRM_KANBAN_NO_"+t.toUpperCase()),BX.proxy_context)},this));BX.bind(this["contact"+c],"mouseout",BX.delegate(this.hideTooltip,this));this.switchClass(this["contact"+c],l,true)}}return this.container},createLayout:function(){var t=this.getGridData();this.container=BX.create("div",{props:{className:t.entityType==="INVOICE"||t.entityType==="QUOTE"?"crm-kanban-item crm-kanban-item-invoice":"crm-kanban-item"},events:{dblclick:function(){var t=this.getData();window.location.href=t.link}.bind(this),mouseleave:function(){this.removeHoverClass(this.container)}.bind(this)}});this.link=BX.create("a",{props:{className:"crm-kanban-item-title"}});this.container.appendChild(this.link);if(t.entityType!=="LEAD"){this.totalPrice=BX.create("div",{props:{className:"crm-kanban-item-total-price"}});this.total=BX.create("div",{props:{className:"crm-kanban-item-total"},children:[this.totalPrice]});this.container.appendChild(this.total)}this.contactName=BX.create("a",{props:{className:"crm-kanban-item-contact"}});this.container.appendChild(this.contactName);this.date=BX.create("div",{props:{className:"crm-kanban-item-date"}});this.container.appendChild(this.date);if(t.showActivity){this.activityExist=BX.create("span",{props:{className:"crm-kanban-item-activity"},events:{click:BX.delegate(this.showCurrentPlan,this)}});this.activityEmpty=BX.create("span",{props:{className:"crm-kanban-item-activity"},events:{click:BX.delegate(function(){this.showTooltip(this.getMessage(t.entityType),BX.proxy_context,true)},this)}});this.activityPlan=BX.create("span",{props:{className:"crm-kanban-item-plan"},text:"+ "+BX.message("CRM_KANBAN_ACTIVITY_TO_PLAN"),events:{click:BX.delegate(this.showPlannerMenu,this)}});this.planner=BX.create("span",{props:{className:"crm-kanban-item-planner"},children:[this.activityEmpty,this.activityExist,this.activityPlan]});this.container.appendChild(this.planner)}this.contactPhone=BX.create("span",{props:{className:"crm-kanban-item-contact-phone crm-kanban-item-contact-phone-disabled"},attrs:{"data-type":"phone"}});this.contactEmail=BX.create("span",{props:{className:"crm-kanban-item-contact-email crm-kanban-item-contact-email-disabled"},attrs:{"data-type":"email"}});this.contactIm=BX.create("span",{props:{className:"crm-kanban-item-contact-im crm-kanban-item-contact-im-disabled"},attrs:{"data-type":"im"}});this.contactBlock=BX.create("div",{props:{className:"crm-kanban-item-connect"},children:[this.contactPhone,this.contactEmail,this.contactIm]});this.container.appendChild(this.contactBlock);this.container.appendChild(this.createShadow())},getMessage:function(t){var e=BX.create("span");e.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_CHANGE_"+t);var i=e.querySelector(".crm-kanban-item-activity-link");BX.bind(i,"click",function(){this.showPlannerMenu(this.activityPlan);this.popupTooltip.destroy()}.bind(this));return e},getPreloader:function(){return'<div class="crm-kanban-preloader-wapper">\n\t\t\t\t\t\t\t\t<div class="crm-kanban-preloader">\n\t\t\t\t\t\t\t\t\t<svg class="crm-kanban-circular" viewBox="25 25 50 50">\n\t\t\t\t\t\t\t\t\t\t<circle class="crm-kanban-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/>\n\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>'},loadCurrentPlan:function(){this.getGrid().ajax({action:"activities",entity_id:this.getId()},function(t){this.plannerCurrent.setContent(t);this.plannerCurrent.adjustPosition()}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this),"html")},showCurrentPlan:function(){this.plannerCurrent=BX.PopupWindowManager.create("kanban_planner_current",BX.proxy_context,{closeIcon:false,autoHide:true,className:"crm-kanban-popup-plan",closeByEsc:true,contentColor:"white",angle:true,offsetLeft:15,overlay:{backgroundColor:"transparent",opacity:"0"},events:{onAfterPopupShow:BX.delegate(this.loadCurrentPlan,this),onPopupClose:function(){this.plannerCurrent.destroy();BX.removeClass(this.container,"crm-kanban-item-hover");BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this))}.bind(this)}});this.plannerCurrent.setContent(this.getPreloader());this.plannerCurrent.show();BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this))},clickContact:function(){var t=BX.data(BX.proxy_context,"type");var e=this.getData();var i=e[t];if(typeof i==="undefined"){return}if(Array.isArray(i)&&i.length>1){var n=[];for(var a=0,s=i.length;a<s;a++){n.push({value:i[a]["value"],type:t,text:i[a]["value"]+" ("+i[a]["title"]+")",onclick:BX.proxy(this.clickContactItem,this)})}BX.PopupMenu.show("kanban_contact_menu_"+t+this.getId(),BX.proxy_context,n,{autoHide:true,zIndex:1200,offsetLeft:20,angle:true,closeByEsc:true,events:{onPopupClose:function(){BX.removeClass(this.container,"crm-kanban-item-hover");BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this))}.bind(this)}});BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this))}else{if(!Array.isArray(i)){i=[i]}this.clickContactItem(0,{value:i[0]["value"],type:t})}},clickContactItem:function(t,e){var i=this.getData();if(e.type==="phone"&&typeof BXIM!=="undefined"){BXIM.phoneTo(e.value,{ENTITY_TYPE:i.contactType,ENTITY_ID:i.contactId})}else if(e.type==="im"&&typeof BXIM!=="undefined"){BXIM.openMessengerSlider(e.value,{RECENT:"N",MENU:"N"})}else if(e.type==="email"){var n=BX.CrmActivityEditor&&BX.CrmActivityEditor.items["kanban_activity_editor"];var a=top.BX.Bitrix24&&top.BX.Bitrix24.Slider;if(n&&BX.CrmActivityProvider&&a){var s=this.getGridData();BX.CrmActivityEditor.items["kanban_activity_editor"].addEmail({ownerType:s.entityType,ownerID:i.id,communications:[{type:"EMAIL",value:e.value,entityId:i.id,entityType:s.entityType,entityTitle:i.name}],communicationsLoaded:true})}else{top.location.href="mailto:"+e.value}}},selectPlannerMenu:function(t,e){var i=this.getGridData();if(e.type==="meeting"||e.type==="call"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType[e.type],OWNER_TYPE:i.entityType,OWNER_ID:this.getId()})}else if(e.type==="task"){if(typeof window["taskIFramePopup"]!=="undefined"){var n={UF_CRM_TASK:[BX.CrmOwnerTypeAbbr.resolve(i.entityType)+"_"+this.getId()],TITLE:"CRM: ",TAGS:"crm"};window["taskIFramePopup"].add(n)}}else if(e.type==="visit"){var a=i.visitParams;a.OWNER_TYPE=i.entityType;a.OWNER_ID=this.getId();BX.CrmActivityVisit.create(a).showEdit()}var s=BX.PopupMenu.getCurrentMenu();if(s){s.close()}},getPlannerMenu:function(){return[{type:"call",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_CALL"),onclick:BX.delegate(this.selectPlannerMenu,this)},{type:"meeting",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_MEETING"),onclick:BX.delegate(this.selectPlannerMenu,this)},{type:"visit",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_VISIT"),onclick:BX.delegate(this.selectPlannerMenu,this)},{type:"task",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_TASK"),onclick:BX.delegate(this.selectPlannerMenu,this)}]},showPlannerMenu:function(t){var e=BX.PopupMenu.create("kanban_planner_menu_"+this.getId(),t.isNode?t:this.activityPlan,this.getPlannerMenu(),{className:"crm-kanban-planner-popup-window",autoHide:true,offsetLeft:50,angle:true,overlay:{backgroundColor:"transparent",opacity:"0"},events:{onPopupClose:function(){BX.removeClass(this.container,"crm-kanban-item-hover");BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this));e.destroy()}.bind(this)}});e.show();BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this))},switchPlanner:function(){var t=this.getData();var e=this.getColumn();var i=e.getData();if(t.activityProgress>0){this.switchVisible(this.activityExist,true);this.switchVisible(this.activityEmpty,false);this.activityExist.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_MY")+(t.activityErrorTotal&&i.type==="PROGRESS"?" <span>"+t.activityErrorTotal+"</span>":"")}else{this.switchVisible(this.activityExist,false);this.switchVisible(this.activityPlan,true);this.switchVisible(this.activityEmpty,true);this.activityEmpty.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_MY")+(i.type==="PROGRESS"?" <span>1</span>":"")}},showTooltip:function(t,e,i){this.popupTooltip=new BX.PopupWindow("kanban_tooltip",BX.proxy_context,{className:i?"crm-kanban-without-tooltip crm-kanban-without-tooltip-white":"crm-kanban-without-tooltip crm-kanban-tooltip-animate",offsetLeft:14,darkMode:i?false:true,overlay:i?{background:"black",opacity:0}:null,closeByEsc:true,angle:true,autoHide:true,content:t,events:{onPopupClose:function(){BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this))}.bind(this)}});BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this));this.popupTooltip.show()},hideTooltip:function(){this.popupTooltip.destroy()},createShadow:function(){return BX.create("div",{props:{className:"crm-kanban-item-shadow"}})},removeHoverClass:function(t){BX.removeClass(t,"crm-kanban-item-event");BX.removeClass(t,"crm-kanban-item-hover")},adjustPopup:function(){var t=BX.PopupWindowManager.getCurrentPopup();if(!t){if(e){var e=BX.PopupMenu.getCurrentMenu();t=e.getPopupWindow()}}if(t){t.adjustPosition()}}}})();