BX.namespace("Crm.KanbanComponent");BX.Crm.KanbanComponent.currentPopupItem=null;BX.Crm.KanbanComponent.currentPopup=null;BX.Crm.KanbanComponent.currentData=null;BX.Crm.KanbanComponent.successClosePopup=false;BX.Crm.KanbanComponent.dropConfirmed=false;BX.Crm.KanbanComponent.returnItem=function(e){var n=e.getLastPosition();var t=e.getData();var o=e.getGrid();var r=parseFloat(t.price);t.columnId=n.columnId;t.targetId=n.targetId;e.getColumn().decPrice(r);o.getColumn(t.columnId).incPrice(r);o.updateItem(e.getId(),t);o.unhideItem(e)};BX.Crm.KanbanComponent.clearPopup=function(e){var n=BX.findChild(BX(e),{className:"crm-kanban-popup-field"},true,true);if(n&&n.length>0){for(var t=0,o=n.length;t<o;t++){var r=BX.data(n[t],"default");n[t].value=r?r:""}}};BX.Crm.KanbanComponent.collectFieldsPopup=function(e){var n=BX.findChild(BX(e),{className:"crm-kanban-popup-field"},true,true);var t={};if(n&&n.length>0){for(var o=0,r=n.length;o<r;o++){var a=BX.data(n[o],"field");if(a){t[a]=n[o].value}}}return t};BX.Crm.KanbanComponent.showPopup=function(e,n,t){BX.Crm.KanbanComponent.currentPopupItem=n.item;this.currentPopup=new BX.PopupWindow("kanban_column_popup",window.body,{closeIcon:true,offsetLeft:0,lightShadow:true,overlay:true,titleBar:{content:BX.create("span",{html:""})},draggable:true,contentColor:"white",closeByEsc:true,events:{onPopupClose:function(){if(!this.successClosePopup){this.returnItem(n.item)}this.dropConfirmed=false}.bind(this)},buttons:[e!=="crm_kanban_lead_win"?new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_POPUP_PARAMS_SAVE"),className:"popup-window-button-accept",events:{click:function(){if(t.toLowerCase()==="column"){var o=n.item.getGrid();o.setAjaxParams(this.collectFieldsPopup(e));o.onItemMoved(n.item,n.targetColumn,n.beforeItem,true);this.successClosePopup=true}else if(t.toLowerCase()==="dropzone"){var r=n.getItem();var o=r.getGrid();var a=n.getDropZone();o.setAjaxParams(this.collectFieldsPopup(e));o.unhideItem(r);a.captureItem(r);this.successClosePopup=true}this.currentPopup.close()}.bind(this)}}):null,new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_POPUP_PARAMS_CANCEL"),className:"popup-window-button-decline",events:{click:function(){this.returnItem(n.item);this.currentPopup.close()}.bind(this)}})]});this.clearPopup(e);this.currentPopup.setContent(BX(e));this.currentPopup.setTitleBar(BX.data(BX(e),"title"));this.currentPopup.show()};BX.Crm.KanbanComponent.leadConvert=function(e){var n=this.currentData;if(!n||!n.item){return}var t=n.item.getId();this.successClosePopup=true;this.currentPopup.close();if(e==="SELECT"){BX.CrmLeadConverter.getCurrent().openEntitySelector(function(e){BX.Crm.KanbanComponent.currentPopupItem=null;BX.CrmLeadConverter.getCurrent().convert(t,e.config,"",e.data)})}else{BX.CrmLeadConverter.getCurrent().convert(t,BX.CrmLeadConversionScheme.createConfig(e),"")}};BX.Crm.KanbanComponent.columnPopup=function(e){var n=e.grid;var t=n.getData();var o=e.item;var r=o.getData();var a=e.targetColumn;var p=a?a.getId():0;BX.Crm.KanbanComponent.currentData=e;if(a&&p!==r.columnId){var u=a.getData();if(u.type==="WIN"&&t.entityType==="LEAD"){BX.Crm.KanbanComponent.showPopup("crm_kanban_lead_win",e,"column");e.skip=true}else if(t.entityType==="INVOICE"){if(u.type==="WIN"){BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_win",e,"column");e.skip=true}else if(u.type==="LOOSE"){BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_loose",e,"column");e.skip=true}}}};BX.Crm.KanbanComponent.dropPopup=function(e,n){var t=e.getData();var o=n.getDropZone();var r=o.getData();var a=n.getItem();if(BX.Crm.KanbanComponent.dropConfirmed!==false){return}else{BX.Crm.KanbanComponent.dropConfirmed=true}if(t.entityType==="LEAD"){if(r.type==="WIN"){e.hideItem(a);BX.Crm.KanbanComponent.currentData={grid:e,item:a,targetColumn:null,beforeItem:null};BX.Crm.KanbanComponent.showPopup("crm_kanban_lead_win",n,"dropzone");n.denyAction()}}else if(t.entityType==="INVOICE"){e.hideItem(a);BX.Crm.KanbanComponent.currentData={grid:e,item:a,targetColumn:null,beforeItem:null};if(r.type==="WIN"){BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_win",n,"dropzone")}else{BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_loose",n,"dropzone")}n.denyAction()}};BX.Crm.KanbanComponent.onPopupClose=function(e){if(e.uniquePopupId==="CRM-lead_converter-popup"&&BX.Crm.KanbanComponent.currentPopupItem!==null){setTimeout(function(){if(BX.Crm.KanbanComponent.currentPopupItem!==null){BX.Crm.KanbanComponent.returnItem(BX.Crm.KanbanComponent.currentPopupItem)}},300)}};