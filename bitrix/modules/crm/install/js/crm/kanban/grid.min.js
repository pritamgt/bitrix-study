(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Grid=function(t){BX.Kanban.Grid.apply(this,arguments);BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemCaptured",BX.delegate(this.onBeforeItemCaptured,this));BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemRestored",BX.delegate(this.onBeforeItemRestored,this));BX.addCustomEvent(this,"Kanban.Grid:onBeforeItemMoved",BX.delegate(this.onBeforeItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onItemMoved",BX.delegate(this.onItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnAddedAsync",BX.delegate(this.onColumnAddedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnUpdated",BX.delegate(this.onColumnUpdated,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnMoved",BX.delegate(this.onColumnMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnRemovedAsync",BX.delegate(this.onColumnRemovedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnLoadAsync",BX.delegate(this.onColumnLoadAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.onItemDragStartHandler,this));BX.addCustomEvent("BX.Main.Filter:apply",BX.delegate(this.onApplyFilter,this));BX.addCustomEvent("BX.CrmEntityCounterPanel:applyFilter",BX.delegate(this.onApplyFilterCounter,this));BX.addCustomEvent("onPullEvent-crm",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onPullEvent-im",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onCrmActivityTodoChecked",BX.proxy(this.onCrmActivityTodoChecked,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.onSliderClose,this));setInterval(BX.proxy(this.loadNew,this),this.loadNewInterval*1e3)};BX.CRM.Kanban.Grid.prototype={__proto__:BX.Kanban.Grid.prototype,constructor:BX.CRM.Kanban.Grid,accessNotifyDialog:null,loadNewInterval:25,ajaxParams:{},getAjaxHandlerPath:function(){var t=this.getData();return BX.type.isNotEmptyString(t.ajaxHandlerPath)?t.ajaxHandlerPath:"/bitrix/components/bitrix/crm.kanban/ajax.php"},setAjaxParams:function(t){this.ajaxParams=t},ajax:function(t,e,a,n){var i=this.getData();var r=this.getAjaxHandlerPath();if(typeof n==="undefined"){n="json"}t.sessid=BX.bitrix_sessid();t.extra=i.params;t.entity_type=i.entityType;t.version=2;t.ajaxParams=this.ajaxParams;if(t.action!=="undefined"){r+=r.indexOf("?")===-1?"?":"&";r+="action="+t.action}BX.ajax({method:"POST",dataType:n,url:r,data:t,onsuccess:e,onfailure:a})},accessNotify:function(){if(typeof BX.Intranet!=="undefined"&&typeof BX.Intranet.NotifyDialog!=="undefined"){if(this.accessNotifyDialog===null){var t=this.getData();this.accessNotifyDialog=new BX.Intranet.NotifyDialog({listUserData:[],notificationHandlerUrl:this.getAjaxHandlerPath()+"?action=notifyAdmin&version=2&entity_type="+t.entityType,popupTexts:{sendButton:BX.message("CRM_KANBAN_NOTIFY_BUTTON"),title:BX.message("CRM_KANBAN_NOTIFY_TITLE"),header:BX.message("CRM_KANBAN_NOTIFY_HEADER"),description:BX.message("CRM_KANBAN_NOTIFY_TEXT")}})}this.accessNotifyDialog.setUsersForNotify(this.getData().admins);this.accessNotifyDialog.show()}},addStage:function(t){var e=new BX.Promise;var a=this.getPreviousColumnSibling(t);var n=a?a.getId():0;this.ajax({action:"modifyStage",columnName:t.getName(),columnColor:t.getColor(),afterColumnId:n},function(t){if(t&&!t.error){e.fulfill(t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},removeStage:function(t){var e=new BX.Promise;this.ajax({action:"modifyStage",columnId:t.getId(),delete:1},function(t){if(t&&!t.error){e.fulfill()}else if(t){e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},getColumnItems:function(t){var e=new BX.Promise;this.ajax({action:"page",page:t.getPagination().getPage()+1,column:t.getId()},function(t){if(t&&(BX.type.isArray(t)||BX.type.isArray(t.items))&&!t.error){e.fulfill(BX.type.isArray(t)?t:t.items)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},addItemTop:function(t){var e=this.getColumn(t.columnId);var a=e?e.getItems():[];if(a.length>0){t.targetId=a[0].getId()}e.incPrice(t.data.price);this.addItem(t)},loadNew:function(t){var e=this.getData();var a=typeof t!=="undefined"?t:0;this.ajax(a?{action:"get",entity_id:a}:{action:"get",min_entity_id:e.lastId},function(t){if(t&&t.items){if(t.items.length>0){for(var n=t.items.length-1;n>=0;n--){var i=t.items[n];var r=this.getItem(i.id);if(r){var o=r.getData();var s=r.getColumn();var d=this.getColumn(i.columnId);this.updateItem(i.id,i);s.decPrice(parseFloat(o.price));d.incPrice(parseFloat(i.data.price));s.renderSubTitle();d.renderSubTitle()}else{this.addItemTop(i)}if(!a){e.lastId=i.id;this.setData(e)}}}else if(a){var i=this.getItem(a);var l=i.getData();var u=i.getColumn();u.decPrice(l.price);this.removeItem(a)}}}.bind(this),function(t){}.bind(this))},onItemDragStart:function(t){this.setDragMode(BX.Kanban.DragMode.ITEM);var e=this.getData();var a=this.getItems();var n=t.getColumn().getData();var i=t.getColumnId();if(e.entityType==="LEAD"&&n.type==="WIN"){for(var r in a){var o=a[r].getColumnId();if(o===i){a[r].enableDropping()}}return}BX.Kanban.Grid.prototype.onItemDragStart.apply(this,arguments)},onItemDragStartHandler:function(t){t.setLastPosition()},onColumnLoadAsync:function(t){t.push(BX.delegate(this.getColumnItems,this))},onColumnRemovedAsync:function(t){t.push(BX.delegate(this.removeStage,this))},onColumnAddedAsync:function(t){t.push(BX.delegate(this.addStage,this))},onBeforeItemCaptured:function(t){BX.onCustomEvent("Crm.Kanban.Grid:onBeforeItemCapturedStart",[this,t]);if(t.isActionAllowed()){var e=t.getItem();var a=e.getColumn();var n=t.getDropZone();var i=parseFloat(e.getData().price);a.decPrice(i);this.onItemMoved(e,n,null,true)}},onBeforeItemRestored:function(t){var e=t.getItem();var a=e.getColumn();var n=parseFloat(e.getData().price);a.incPrice(n);this.onItemMoved(e,a)},onBeforeItemMoved:function(t){var e=t.getTargetColumn();var a=t.getItem();var n=a.getColumn();var i=parseFloat(a.getData().price);n.decPrice(i);e.incPrice(i)},onItemMoved:function(t,e,a,n){if(n!==true){var i={grid:this,item:t,targetColumn:e,beforeItem:a,skip:false};BX.onCustomEvent("Crm.Kanban.Grid:onItemMovedFinal",[i]);if(i.skip===true){return}}var r=0;var o=t.getId();var s=e?e.getId():0;if(e instanceof BX.Kanban.DropZone){r=0}else{var d=e.getPreviousItemSibling(t);if(d){r=d.getId()}}this.ajax({action:"status",entity_id:o,prev_entity_id:r,status:s},function(e){if(e&&!e.error){if(e.items&&e.items.length>0){this.updateItem(o,e.items[0])}else{t.setDataKey("columnId",s)}}else if(e){BX.Kanban.Utils.showErrorDialog(e.error,true)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onColumnUpdated:function(t){var e=t.getId();var a=t.getName();var n=t.getColor();this.ajax({action:"modifyStage",columnId:e,columnName:a,columnColor:n},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onColumnMoved:function(t,e){var a=t.getId();var n=this.getPreviousColumnSibling(t);var i=n?n.getId():0;this.ajax({action:"modifyStage",columnId:a,afterColumnId:i},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,true)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onApplyFilter:function(t,e,a,n,i){this.fadeOut();i.autoResolve=false;this.ajax({action:"get"},function(t){var e=[],a=null;var i=this.getColumns();for(var r=0,o=i.length;r<o;r++){a=i[r].getId();e.push(a);this.removeColumn(a)}this.removeItems();this.loadData(t);var s=this.getDropZoneArea();var d=this.getDropZoneArea().getDropZones();for(var r=0,o=d.length;r<o;r++){s.removeDropZone(d[r])}if(t.dropzones){for(var r=0,o=t.dropzones.length;r<o;r++){s.addDropZone(t.dropzones[r])}}var l=null;i=this.getColumns();for(var r=0,o=i.length;r<o;r++){a=i[r].getId();if(!BX.util.in_array(a,e)){l=i[r]}}if(l!==null){this.addClassEar()}this.fadeIn();n.fulfill()}.bind(this),function(t){n.reject();this.fadeIn()}.bind(this))},addClassEar:function(){var t=document.querySelector(".main-kanban-ear-right");t.classList.contains("crm-kanban-ear-animate")?BX.removeClass("crm-kanban-ear-animate"):null;BX.addClass(t,"crm-kanban-ear-animate")},onApplyFilterCounter:function(t,e){setTimeout(BX.delegate(function(){var t=this.getData();var a={ASSIGNED_BY_ID:{0:e["userId"]},ASSIGNED_BY_ID_label:[e["userName"]],ACTIVITY_COUNTER:{0:e["counterTypeId"]}};var n=BX.Main.filterManager.getById(t.gridId);var i=n.getApi();i.setFields(a);i.apply()},this),0);e["cancel"]=true},onPullEventHandlerCrm:function(t,e){var a=this.getData();if(t==="activity_add"&&e.COMPLETED!=="Y"&&e.OWNER_TYPE_NAME===a.entityType){var n=this.getItem(e.OWNER_ID);if(n){this.loadNew(n.getId())}}if(t==="notify"){var i=e.originalTag.match(new RegExp("CRM\\|"+a.entityType+"_RESPONSIBLE\\|([\\d]+)"));if(i&&i[1]){this.loadNew(i[1])}if(a.entityType==="INVOICE"&&e.settingName==="crm|invoice_responsible_changed"){var i=e.originalTag.match(new RegExp("CRM\\|"+a.entityType+"\\|([\\d]+)"));if(i&&i[1]){this.loadNew(i[1])}}}},onCrmActivityTodoChecked:function(t,e,a,n){var i=this.getItem(e);if(i){if(n){var r=i.getDataKey("activityErrorTotal");r--;i.setDataKey("activityErrorTotal",r)}var o=i.getDataKey("activityProgress");o--;i.setDataKey("activityProgress",o);i.switchPlanner()}},onSliderClose:function(t){var e=this.getData();var a=e.entityPath;var n=t.slider.getUrl();a=a.replace(/\#([^\#]+)\#/,"([\\d]+)");var i=n.match(new RegExp(a));if(i&&i[1]){this.loadNew(i[1])}}}})();