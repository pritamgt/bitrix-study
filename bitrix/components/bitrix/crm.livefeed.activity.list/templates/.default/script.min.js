if(typeof BX.CrmEntityLiveFeedActivityList==="undefined"){BX.CrmEntityLiveFeedActivityList=function(){this._prefix="";this._activityEditor=null;this._items={}};BX.CrmEntityLiveFeedActivityList.prototype={initialize:function(t,i){this._id=t;this._settings=i;this._prefix=this.getSetting("prefix");var e=this.getSetting("activityEditorId","");if(BX.type.isNotEmptyString(e)&&typeof(BX.CrmActivityEditor!=="undefined")){this._activityEditor=typeof BX.CrmActivityEditor.items[e]!=="undefined"?BX.CrmActivityEditor.items[e]:null}var n=this._resolveElement("activities");if(n){var s=this.getSetting("data",[]);for(var a=0;a<s.length;a++){var r=s[a];var l=parseInt(r["ID"]);var c=BX.findChild(n,{attribute:{"data-entity-id":l}},true,false);if(c){this._items[l.toString()]=BX.CrmEntityLiveFeedActivity.create(l,{activityEditor:this._activityEditor,container:c,clientTemplate:this.getSetting("clientTemplate",""),referenceTemplate:this.getSetting("referenceTemplate",""),params:BX.CrmParamBag.create(r)})}}}},getSetting:function(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i},setSetting:function(t,i){this._settings[t]=i},_resolveElement:function(t){var i=t;if(this._prefix){i=this._prefix+i}return BX(i)}};BX.CrmEntityLiveFeedActivityList.create=function(t,i){var e=new BX.CrmEntityLiveFeedActivityList;e.initialize(t,i);return e}}if(typeof BX.CrmEntityLiveFeedActivity==="undefined"){BX.CrmEntityLiveFeedActivity=function(){this._settings={};this._id=0;this._activityEditor=null;this._container=this._completeButton=this._subjectElem=this._timeElem=this._responsibleElem=null;this._params=null;this._enableExternalChange=true};BX.CrmEntityLiveFeedActivity.prototype={initialize:function(t,i){this._id=t;this._settings=i;this._activityEditor=this.getSetting("activityEditor",null);if(!this._activityEditor){throw"BX.CrmEntityLiveFeedActivity: Could not find activityEditor."}this._activityEditor.addActivityChangeHandler(BX.delegate(this._onExternalChange,this));this._container=this.getSetting("container");if(!this._container){throw"BX.CrmEntityLiveFeedActivity: Could not find container."}this._completeButton=BX.findChild(this._container,{className:"crm-right-block-checkbox"},true,false);if(this._completeButton){BX.bind(this._completeButton,"click",BX.delegate(this._onCompleteButtonClick,this))}this._subjectElem=BX.findChild(this._container,{className:"crm-right-block-item-title-text"},true,false);if(this._subjectElem){BX.bind(this._subjectElem,"click",BX.delegate(this._onTitleClick,this))}this._timeElem=BX.findChild(this._container,{className:"crm-right-block-date"},true,false);this._responsibleElem=BX.findChild(this._container,{className:"crm-right-block-name"},true,false);this._bindingElem=BX.findChild(this._container,{className:"crm-right-block-item-label"},true,false);this._params=this.getSetting("params",null);if(!this._params){this._params=BX.CrmParamBag.create()}},getId:function(){return this._id},getSetting:function(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i},setSetting:function(t,i){this._settings[t]=i},isCompleted:function(){return this._params.getBooleanParam("completed",false)},setCompleted:function(t){t=!!t;if(this.isCompleted()!==t){this._enableExternalChange=false;this._activityEditor.setActivityCompleted(this._id,t,BX.delegate(this._onComplete,this))}},layout:function(t){t=!!t;var i=this._params.getIntParam("typeID",0);var e=this._params.getIntParam("direction",0);var n=this._params.getBooleanParam("completed",false);var s="";if(i===BX.CrmActivityType.call){s=e===BX.CrmActivityDirection.incoming?"crm-right-block-call":"crm-right-block-call-to"}else if(i===BX.CrmActivityType.meeting){s="crm-right-block-meet"}else if(i===BX.CrmActivityType.task){s="crm-right-block-task"}if(n){BX.removeClass(this._container,s);BX.addClass(this._container,s+"-done")}else{BX.removeClass(this._container,s+"-done");BX.addClass(this._container,s)}var a=new Date;var r=BX.parseDate(this._params.getParam("deadline"));if(!r){r=new Date}if(this._timeElem){if(!n&&r<=a){BX.addClass(this._container,"crm-right-block-deadline")}else{BX.removeClass(this._container,"crm-right-block-deadline")}}if(t){return}if(this._subjectElem&&this._params.getParam("subject")){this._subjectElem.innerHTML=BX.util.htmlspecialchars(this._params.getParam("subject"))}if(this._completeButton&&this._completeButton.checked!==n){this._completeButton.checked=n}if(this._timeElem){this._timeElem.innerHTML=BX.CrmActivityEditor.trimDateTimeString(BX.date.format(BX.CrmActivityEditor.getDateTimeFormat(),r))}if(this._responsibleElem){this._responsibleElem.innerHTML=BX.util.htmlspecialchars(this._params.getParam("responsibleName"))}if(this._bindingElem){var l=this._params.getParam("clientTitle","");var c=l!==""?this.getSetting("clientTemplate").replace(/#CLIENT#/gi,l):"";var o=this._params.getParam("ownerType","");var m=this._params.getParam("ownerTitle","");var h=m!==""&&(o=="DEAL"||o=="LEAD")?this.getSetting("referenceTemplate").replace(/#REFERENCE#/gi,m):"";var d=c;if(h!==""){if(d!==""){d+=" "}d+=h}this._bindingElem.innerHTML=BX.util.htmlspecialchars(d)}},_onCompleteButtonClick:function(t){this.setCompleted(!this.isCompleted())},_onComplete:function(t){this._enableExternalChange=true;if(BX.type.isBoolean(t["COMPLETED"])){this._params.setParam("completed",t["COMPLETED"])}this.layout(true)},_onTitleClick:function(t){this._activityEditor.viewActivity(this._id);return BX.PreventDefault(t)},_onExternalChange:function(t,i,e){if(!this._enableExternalChange){return}var n=typeof e["ID"]!=="undefined"?parseInt(e["ID"]):0;if(this._id!==n){return}this._params.merge(e);if(BX.type.isArray(e["communications"])){var s=e["communications"];for(var a=0;a<s.length;a++){var r=s[a];var l=r["entityType"];if(l==="CONTACT"||l==="COMPANY"){this._params.setParam("clientTitle",BX.type.isNotEmptyString(r["entityTitle"])?r["entityTitle"]:"");break}}}else{this._params.setParam("clientTitle","")}this.layout(false)}};BX.CrmEntityLiveFeedActivity.create=function(t,i){var e=new BX.CrmEntityLiveFeedActivity;e.initialize(t,i);return e}}